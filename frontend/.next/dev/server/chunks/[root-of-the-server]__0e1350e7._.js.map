{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///E:/SignalHub/frontend/src/app/api/auth/reset-pass/send-otp/route.ts"],"sourcesContent":["// app/api/auth/reset-pass/send-otp/route.ts\r\nimport { NextResponse } from \"next/server\";\r\nimport type { NextRequest } from \"next/server\";\r\nimport nodemailer from \"nodemailer\";\r\n\r\n/**\r\n * Dev/Prod helper:\r\n * - Generates a 6-digit OTP, stores in ephemeral in-memory OTP_STORE with expiry.\r\n * - Sends OTP by SMTP if SMTP_* env vars provided; otherwise logs OTP to server console.\r\n *\r\n * Environment (optional for emails):\r\n * - SMTP_HOST\r\n * - SMTP_PORT (number)\r\n * - SMTP_SECURE (\"true\" or \"false\")\r\n * - SMTP_USER\r\n * - SMTP_PASS\r\n * - FROM_EMAIL\r\n *\r\n * NOTE: This is a dev-friendly handler. In production:\r\n * - Use Redis or DB for OTP store with TTL.\r\n * - Rate-limit send-otp per email & per IP.\r\n * - Use an email provider (SendGrid/Resend/SES) with verified domain.\r\n */\r\n\r\ntype OtpEntry = { code: string; expiresAt: number };\r\n\r\nconst OTP_STORE = (global as any).__RESET_PASS_OTP_STORE__ || ((global as any).__RESET_PASS_OTP_STORE__ = new Map<string, OtpEntry>());\r\n\r\nfunction genOtp() {\r\n  return Math.floor(100000 + Math.random() * 900000).toString();\r\n}\r\n\r\nasync function trySendEmail({ to, subject, html }: { to: string; subject: string; html: string }) {\r\n  const host = process.env.SMTP_HOST;\r\n  if (!host) {\r\n    // no SMTP configured â€” nothing to do\r\n    return { sent: false, message: \"No SMTP configured; OTP logged to console.\" };\r\n  }\r\n\r\n  const port = Number(process.env.SMTP_PORT || 587);\r\n  const secure = (process.env.SMTP_SECURE || \"false\") === \"true\";\r\n  const user = process.env.SMTP_USER;\r\n  const pass = process.env.SMTP_PASS;\r\n  const from = process.env.FROM_EMAIL || user || `no-reply@localhost`;\r\n\r\n  const transporter = nodemailer.createTransport({\r\n    host,\r\n    port,\r\n    secure,\r\n    auth: user && pass ? { user, pass } : undefined,\r\n  });\r\n\r\n  const info = await transporter.sendMail({ from, to, subject, html });\r\n  return { sent: true, info };\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { email } = await req.json();\r\n    const normalized = String(email ?? \"\").trim().toLowerCase();\r\n    if (!normalized || !/^\\S+@\\S+\\.\\S+$/.test(normalized)) {\r\n      return NextResponse.json({ error: \"Invalid email\" }, { status: 400 });\r\n    }\r\n\r\n    // Generate OTP\r\n    const code = genOtp();\r\n    const expiresAt = Date.now() + 5 * 60 * 1000; // 5 minutes\r\n    OTP_STORE.set(normalized, { code, expiresAt });\r\n\r\n    // Attempt to send via SMTP\r\n    const subject = \"Your password reset code\";\r\n    const html = `<p>Your password reset code is <strong>${code}</strong>. It expires in 5 minutes.</p>`;\r\n\r\n    try {\r\n      const result = await trySendEmail({ to: normalized, subject, html });\r\n      if (result.sent) {\r\n        console.log(`[reset-pass] Sent OTP email to ${normalized}`);\r\n        return NextResponse.json({ ok: true, message: \"OTP sent\" }, { status: 200 });\r\n      } else {\r\n        // Fallback: log OTP so dev can use it\r\n        console.log(`[reset-pass] OTP for ${normalized}: ${code} (logged; SMTP not configured)`);\r\n        return NextResponse.json({ ok: true, message: \"OTP generated (logged to server)\", debug: result.message }, { status: 200 });\r\n      }\r\n    } catch (sendErr) {\r\n      console.error(\"Error sending OTP email:\", sendErr);\r\n      // fallback to console log\r\n      console.log(`[reset-pass] OTP for ${normalized}: ${code} (send failed)`);\r\n      return NextResponse.json({ ok: true, message: \"OTP generated (send failed; logged to server)\" }, { status: 200 });\r\n    }\r\n  } catch (err) {\r\n    console.error(\"send-otp error\", err);\r\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"AAAA,4CAA4C;;;;;AAC5C;AAEA;;;AAuBA,MAAM,YAAY,yDAAgB,wBAAwB,IAAI,CAAC,yDAAgB,wBAAwB,GAAG,IAAI,KAAuB;AAErI,SAAS;IACP,OAAO,KAAK,KAAK,CAAC,SAAS,KAAK,MAAM,KAAK,QAAQ,QAAQ;AAC7D;AAEA,eAAe,aAAa,EAAE,EAAE,EAAE,OAAO,EAAE,IAAI,EAAiD;IAC9F,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,IAAI,CAAC,MAAM;QACT,qCAAqC;QACrC,OAAO;YAAE,MAAM;YAAO,SAAS;QAA6C;IAC9E;IAEA,MAAM,OAAO,OAAO,QAAQ,GAAG,CAAC,SAAS,IAAI;IAC7C,MAAM,SAAS,CAAC,QAAQ,GAAG,CAAC,WAAW,IAAI,OAAO,MAAM;IACxD,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,MAAM,OAAO,QAAQ,GAAG,CAAC,UAAU,IAAI,QAAQ,CAAC,kBAAkB,CAAC;IAEnE,MAAM,cAAc,4JAAU,CAAC,eAAe,CAAC;QAC7C;QACA;QACA;QACA,MAAM,QAAQ,OAAO;YAAE;YAAM;QAAK,IAAI;IACxC;IAEA,MAAM,OAAO,MAAM,YAAY,QAAQ,CAAC;QAAE;QAAM;QAAI;QAAS;IAAK;IAClE,OAAO;QAAE,MAAM;QAAM;IAAK;AAC5B;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,IAAI;QAChC,MAAM,aAAa,OAAO,SAAS,IAAI,IAAI,GAAG,WAAW;QACzD,IAAI,CAAC,cAAc,CAAC,iBAAiB,IAAI,CAAC,aAAa;YACrD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,eAAe;QACf,MAAM,OAAO;QACb,MAAM,YAAY,KAAK,GAAG,KAAK,IAAI,KAAK,MAAM,YAAY;QAC1D,UAAU,GAAG,CAAC,YAAY;YAAE;YAAM;QAAU;QAE5C,2BAA2B;QAC3B,MAAM,UAAU;QAChB,MAAM,OAAO,CAAC,uCAAuC,EAAE,KAAK,uCAAuC,CAAC;QAEpG,IAAI;YACF,MAAM,SAAS,MAAM,aAAa;gBAAE,IAAI;gBAAY;gBAAS;YAAK;YAClE,IAAI,OAAO,IAAI,EAAE;gBACf,QAAQ,GAAG,CAAC,CAAC,+BAA+B,EAAE,YAAY;gBAC1D,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,IAAI;oBAAM,SAAS;gBAAW,GAAG;oBAAE,QAAQ;gBAAI;YAC5E,OAAO;gBACL,sCAAsC;gBACtC,QAAQ,GAAG,CAAC,CAAC,qBAAqB,EAAE,WAAW,EAAE,EAAE,KAAK,8BAA8B,CAAC;gBACvF,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,IAAI;oBAAM,SAAS;oBAAoC,OAAO,OAAO,OAAO;gBAAC,GAAG;oBAAE,QAAQ;gBAAI;YAC3H;QACF,EAAE,OAAO,SAAS;YAChB,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,0BAA0B;YAC1B,QAAQ,GAAG,CAAC,CAAC,qBAAqB,EAAE,WAAW,EAAE,EAAE,KAAK,cAAc,CAAC;YACvE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAM,SAAS;YAAgD,GAAG;gBAAE,QAAQ;YAAI;QACjH;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,kBAAkB;QAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF","debugId":null}}]
}