{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attackcapital/SignalHub/frontend/src/components/modals/ConfirmModal.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useEffect, useRef } from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\n\r\ntype ConfirmModalProps = {\r\n  open: boolean;\r\n  title?: string;\r\n  message?: string;\r\n  confirmLabel?: string;\r\n  cancelLabel?: string;\r\n  onConfirm: () => Promise<void> | void;\r\n  onCancel: () => void;\r\n};\r\n\r\nexport default function ConfirmModal({\r\n  open,\r\n  title = \"Confirm\",\r\n  message = \"Are you sure?\",\r\n  confirmLabel = \"Yes\",\r\n  cancelLabel = \"Cancel\",\r\n  onConfirm,\r\n  onCancel,\r\n}: ConfirmModalProps) {\r\n  const ref = useRef<HTMLDivElement | null>(null);\r\n  const primaryBtnRef = useRef<HTMLButtonElement | null>(null);\r\n\r\n  // prevent background scroll\r\n  useEffect(() => {\r\n    if (!open) return;\r\n    const prev = document.body.style.overflow;\r\n    document.body.style.overflow = \"hidden\";\r\n    primaryBtnRef.current?.focus();\r\n    return () => {\r\n      document.body.style.overflow = prev;\r\n    };\r\n  }, [open]);\r\n\r\n  // close on ESC\r\n  useEffect(() => {\r\n    function onKey(e: KeyboardEvent) {\r\n      if (e.key === \"Escape\") onCancel();\r\n    }\r\n    if (open) window.addEventListener(\"keydown\", onKey);\r\n    return () => window.removeEventListener(\"keydown\", onKey);\r\n  }, [open, onCancel]);\r\n\r\n  if (!open) return null;\r\n\r\n  return ReactDOM.createPortal(\r\n    <div\r\n      role=\"dialog\"\r\n      aria-modal=\"true\"\r\n      aria-labelledby=\"confirm-title\"\r\n      className=\"fixed inset-0 z-50 flex items-center justify-center p-4\"\r\n    >\r\n      <div\r\n        className=\"absolute inset-0 bg-black/40 backdrop-blur-sm\"\r\n        onClick={onCancel}\r\n        aria-hidden\r\n      />\r\n      <div\r\n        ref={ref}\r\n        className=\"relative z-10 max-w-lg w-full bg-white rounded-2xl shadow-xl border p-6\"\r\n      >\r\n        <h3 id=\"confirm-title\" className=\"text-lg font-semibold text-slate-900\">\r\n          {title}\r\n        </h3>\r\n        <p className=\"mt-2 text-sm text-slate-600\">{message}</p>\r\n\r\n        <div className=\"mt-6 flex justify-end gap-3\">\r\n          <button\r\n            onClick={onCancel}\r\n            className=\"px-4 py-2 rounded-lg border text-sm text-slate-700 hover:bg-slate-50\"\r\n          >\r\n            {cancelLabel}\r\n          </button>\r\n          <button\r\n            ref={primaryBtnRef}\r\n            onClick={() => void onConfirm()}\r\n            className=\"px-4 py-2 rounded-lg bg-red-600 text-white text-sm hover:opacity-95\"\r\n          >\r\n            {confirmLabel}\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </div>,\r\n    document.body\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAHA;;;;AAee,SAAS,aAAa,EACnC,IAAI,EACJ,QAAQ,SAAS,EACjB,UAAU,eAAe,EACzB,eAAe,KAAK,EACpB,cAAc,QAAQ,EACtB,SAAS,EACT,QAAQ,EACU;IAClB,MAAM,MAAM,IAAA,2NAAM,EAAwB;IAC1C,MAAM,gBAAgB,IAAA,2NAAM,EAA2B;IAEvD,4BAA4B;IAC5B,IAAA,8NAAS,EAAC;QACR,IAAI,CAAC,MAAM;QACX,MAAM,OAAO,SAAS,IAAI,CAAC,KAAK,CAAC,QAAQ;QACzC,SAAS,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG;QAC/B,cAAc,OAAO,EAAE;QACvB,OAAO;YACL,SAAS,IAAI,CAAC,KAAK,CAAC,QAAQ,GAAG;QACjC;IACF,GAAG;QAAC;KAAK;IAET,eAAe;IACf,IAAA,8NAAS,EAAC;QACR,SAAS,MAAM,CAAgB;YAC7B,IAAI,EAAE,GAAG,KAAK,UAAU;QAC1B;QACA,IAAI,MAAM,OAAO,gBAAgB,CAAC,WAAW;QAC7C,OAAO,IAAM,OAAO,mBAAmB,CAAC,WAAW;IACrD,GAAG;QAAC;QAAM;KAAS;IAEnB,IAAI,CAAC,MAAM,OAAO;IAElB,qBAAO,mOAAQ,CAAC,YAAY,eAC1B,0PAAC;QACC,MAAK;QACL,cAAW;QACX,mBAAgB;QAChB,WAAU;;0BAEV,0PAAC;gBACC,WAAU;gBACV,SAAS;gBACT,aAAW;;;;;;0BAEb,0PAAC;gBACC,KAAK;gBACL,WAAU;;kCAEV,0PAAC;wBAAG,IAAG;wBAAgB,WAAU;kCAC9B;;;;;;kCAEH,0PAAC;wBAAE,WAAU;kCAA+B;;;;;;kCAE5C,0PAAC;wBAAI,WAAU;;0CACb,0PAAC;gCACC,SAAS;gCACT,WAAU;0CAET;;;;;;0CAEH,0PAAC;gCACC,KAAK;gCACL,SAAS,IAAM,KAAK;gCACpB,WAAU;0CAET;;;;;;;;;;;;;;;;;;;;;;;cAKT,SAAS,IAAI;AAEjB","debugId":null}},
    {"offset": {"line": 147, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attackcapital/SignalHub/frontend/src/components/profile/ProfileMenu.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useEffect, useRef, useState } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport ConfirmModal from \"../modals/ConfirmModal\";\r\n\r\nexport default function ProfileMenu({ avatarUrl, email }: { avatarUrl?: string; email?: string }) {\r\n  const router = useRouter();\r\n  const [open, setOpen] = useState(false);\r\n  const [confirmOpen, setConfirmOpen] = useState(false);\r\n  const [loggingOut, setLoggingOut] = useState(false);\r\n  const menuRef = useRef<HTMLDivElement | null>(null);\r\n\r\n  // close on outside click\r\n  useEffect(() => {\r\n    function onDocClick(e: MouseEvent) {\r\n      if (!menuRef.current) return;\r\n      if (!(e.target instanceof Node)) return;\r\n      if (!menuRef.current.contains(e.target)) setOpen(false);\r\n    }\r\n    document.addEventListener(\"mousedown\", onDocClick);\r\n    return () => document.removeEventListener(\"mousedown\", onDocClick);\r\n  }, []);\r\n\r\n  // keyboard support\r\n  useEffect(() => {\r\n    function onKey(e: KeyboardEvent) {\r\n      if (e.key === \"Escape\") setOpen(false);\r\n    }\r\n    if (open) window.addEventListener(\"keydown\", onKey);\r\n    return () => window.removeEventListener(\"keydown\", onKey);\r\n  }, [open]);\r\n\r\n  async function handleLogout() {\r\n    try {\r\n      setLoggingOut(true);\r\n      const res = await fetch(\"/api/auth/logout\", { method: \"POST\" });\r\n      // ignore body; route clears cookie\r\n      setConfirmOpen(false);\r\n      setOpen(false);\r\n      // redirect to login page\r\n      router.replace(\"/auth/login\");\r\n    } catch (err) {\r\n      console.error(\"Logout failed\", err);\r\n      setLoggingOut(false);\r\n      setConfirmOpen(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"relative\" ref={menuRef}>\r\n      <button\r\n        aria-haspopup=\"menu\"\r\n        aria-expanded={open}\r\n        onClick={() => setOpen((v) => !v)}\r\n        className=\"w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center shadow-sm hover:opacity-95\"\r\n        title=\"Account menu\"\r\n      >\r\n        {avatarUrl ? (\r\n          <img src={avatarUrl} alt=\"avatar\" className=\"w-10 h-10 rounded-full object-cover\" />\r\n        ) : (\r\n          <span className=\"text-sm font-medium text-slate-700\">{(email || \"U\").charAt(0).toUpperCase()}</span>\r\n        )}\r\n      </button>\r\n\r\n      {open && (\r\n        <div\r\n          role=\"menu\"\r\n          aria-label=\"Profile\"\r\n          className=\"absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-lg border py-2 z-20\"\r\n        >\r\n          <button\r\n            role=\"menuitem\"\r\n            onClick={() => {\r\n              setOpen(false);\r\n              router.push(\"/profile\");\r\n            }}\r\n            className=\"w-full text-left px-3 py-2 hover:bg-slate-50 text-sm text-slate-700\"\r\n          >\r\n            View profile\r\n          </button>\r\n\r\n          <button\r\n            role=\"menuitem\"\r\n            onClick={() => {\r\n              setConfirmOpen(true);\r\n            }}\r\n            className=\"w-full text-left px-3 py-2 hover:bg-slate-50 text-sm text-slate-700\"\r\n          >\r\n            Logout\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      <ConfirmModal\r\n        open={confirmOpen}\r\n        title=\"Log out?\"\r\n        message=\"Do you want to logout?\"\r\n        confirmLabel={loggingOut ? \"Logging out...\" : \"Yes, log out\"}\r\n        cancelLabel=\"Cancel\"\r\n        onCancel={() => setConfirmOpen(false)}\r\n        onConfirm={async () => {\r\n          await handleLogout();\r\n        }}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAMe,SAAS,YAAY,EAAE,SAAS,EAAE,KAAK,EAA0C;IAC9F,MAAM,SAAS,IAAA,2JAAS;IACxB,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,6NAAQ,EAAC;IACjC,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,6NAAQ,EAAC;IAC/C,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,6NAAQ,EAAC;IAC7C,MAAM,UAAU,IAAA,2NAAM,EAAwB;IAE9C,yBAAyB;IACzB,IAAA,8NAAS,EAAC;QACR,SAAS,WAAW,CAAa;YAC/B,IAAI,CAAC,QAAQ,OAAO,EAAE;YACtB,IAAI,CAAC,CAAC,EAAE,MAAM,YAAY,IAAI,GAAG;YACjC,IAAI,CAAC,QAAQ,OAAO,CAAC,QAAQ,CAAC,EAAE,MAAM,GAAG,QAAQ;QACnD;QACA,SAAS,gBAAgB,CAAC,aAAa;QACvC,OAAO,IAAM,SAAS,mBAAmB,CAAC,aAAa;IACzD,GAAG,EAAE;IAEL,mBAAmB;IACnB,IAAA,8NAAS,EAAC;QACR,SAAS,MAAM,CAAgB;YAC7B,IAAI,EAAE,GAAG,KAAK,UAAU,QAAQ;QAClC;QACA,IAAI,MAAM,OAAO,gBAAgB,CAAC,WAAW;QAC7C,OAAO,IAAM,OAAO,mBAAmB,CAAC,WAAW;IACrD,GAAG;QAAC;KAAK;IAET,eAAe;QACb,IAAI;YACF,cAAc;YACd,MAAM,MAAM,MAAM,MAAM,oBAAoB;gBAAE,QAAQ;YAAO;YAC7D,mCAAmC;YACnC,eAAe;YACf,QAAQ;YACR,yBAAyB;YACzB,OAAO,OAAO,CAAC;QACjB,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,iBAAiB;YAC/B,cAAc;YACd,eAAe;QACjB;IACF;IAEA,qBACE,0PAAC;QAAI,WAAU;QAAW,KAAK;;0BAC7B,0PAAC;gBACC,iBAAc;gBACd,iBAAe;gBACf,SAAS,IAAM,QAAQ,CAAC,IAAM,CAAC;gBAC/B,WAAU;gBACV,OAAM;0BAEL,0BACC,0PAAC;oBAAI,KAAK;oBAAW,KAAI;oBAAS,WAAU;;;;;yCAE5C,0PAAC;oBAAK,WAAU;8BAAsC,CAAC,SAAS,GAAG,EAAE,MAAM,CAAC,GAAG,WAAW;;;;;;;;;;;YAI7F,sBACC,0PAAC;gBACC,MAAK;gBACL,cAAW;gBACX,WAAU;;kCAEV,0PAAC;wBACC,MAAK;wBACL,SAAS;4BACP,QAAQ;4BACR,OAAO,IAAI,CAAC;wBACd;wBACA,WAAU;kCACX;;;;;;kCAID,0PAAC;wBACC,MAAK;wBACL,SAAS;4BACP,eAAe;wBACjB;wBACA,WAAU;kCACX;;;;;;;;;;;;0BAML,0PAAC,mKAAY;gBACX,MAAM;gBACN,OAAM;gBACN,SAAQ;gBACR,cAAc,aAAa,mBAAmB;gBAC9C,aAAY;gBACZ,UAAU,IAAM,eAAe;gBAC/B,WAAW;oBACT,MAAM;gBACR;;;;;;;;;;;;AAIR","debugId":null}},
    {"offset": {"line": 302, "column": 0}, "map": {"version":3,"sources":["file:///E:/Attackcapital/SignalHub/frontend/src/app/welcome/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport React, { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport ProfileMenu from \"@/components/profile/ProfileMenu\";\r\nimport * as Y from \"yjs\";\r\nimport { WebsocketProvider } from \"y-websocket\";\r\n\r\n/**\r\n * Enhanced Welcome page\r\n * - Keeps all existing API calls / behavior unchanged\r\n * - Adds a functional Integrations modal (fetch & buy Twilio numbers)\r\n * - Adds a full Inbox panel with search & filters (name, unread, scheduled, drafts)\r\n * - Inbox can open as a full panel or be minimized to a floating messenger bubble (like Facebook Messenger)\r\n *\r\n * Notes:\r\n * - This is a single file client component intended to replace your existing page.tsx\r\n * - All server interactions use the same endpoints present in your original file\r\n */\r\n\r\n/* ----------------------------- types ---------------------------- */\r\n\r\ntype Role = \"VIEWER\" | \"EDITOR\" | \"ADMIN\" | string;\r\n\r\ntype User = {\r\n  id: string;\r\n  email?: string;\r\n  name?: string;\r\n  role?: Role;\r\n};\r\n\r\ntype ThreadPreviewItem = {\r\n  id: string;\r\n  contactId?: string;\r\n  contactName?: string;\r\n  contactPhone?: string;\r\n  channels?: string[];\r\n  snippet?: string;\r\n  lastAt?: string; // ISO\r\n  unreadCount?: number;\r\n  status?: \"inbox\" | \"unread\" | \"scheduled\" | \"archived\" | \"draft\" | string;\r\n  scheduled?: boolean;\r\n  isDraft?: boolean;\r\n};\r\n\r\ntype ProviderNumber = {\r\n  id: string;\r\n  phone: string;\r\n  provider?: string;\r\n  capabilities?: Record<string, boolean>;\r\n  purchased?: boolean;\r\n};\r\n\r\ntype ContactItem = {\r\n  id: string;\r\n  name?: string | null;\r\n  email?: string | null;\r\n  emailVerified?: boolean;\r\n  phone?: string | null;\r\n  phoneVerified?: boolean;\r\n};\r\n\r\ntype AnalyticsSummary = {\r\n  messages7d?: number;\r\n  avgResponseMins?: number;\r\n  openRatePct?: number;\r\n  sparkline?: number[];\r\n};\r\n\r\n/* ----------------------------- helpers ---------------------------- */\r\n\r\nfunction formatShortDate(iso?: string) {\r\n  if (!iso) return \"—\";\r\n  try {\r\n    const d = new Date(iso);\r\n    return d.toLocaleString();\r\n  } catch {\r\n    return iso;\r\n  }\r\n}\r\n\r\n/* ----------------------------- Main Page ---------------------------- */\r\n\r\nexport default function WelcomePage() {\r\n  const router = useRouter();\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  const [analytics, setAnalytics] = useState<AnalyticsSummary | null>(null);\r\n  const [threads, setThreads] = useState<ThreadPreviewItem[]>([]);\r\n  const [numbers, setNumbers] = useState<ProviderNumber[]>([]);\r\n  const [contacts, setContacts] = useState<ContactItem[]>([]);\r\n\r\n  const [composerOpen, setComposerOpen] = useState(false);\r\n  const [composerContext, setComposerContext] = useState<{ threadId?: string; contactId?: string } | null>(null);\r\n  const [contactModal, setContactModal] = useState<{ contactId: string } | null>(null);\r\n  const [buying, setBuying] = useState<string | null>(null);\r\n\r\n  const [presence, setPresence] = useState<Record<string, { name?: string; idle?: boolean }>>({});\r\n\r\n  const wsRef = useRef<WebSocket | null>(null);\r\n\r\n  // NEW: UI states for integrations + inbox widget\r\n  const [integrationsOpen, setIntegrationsOpen] = useState(false);\r\n\r\n  // Inbox panel (full) visibility + minimization\r\n  const [inboxOpen, setInboxOpen] = useState(false);\r\n  const [inboxMinimized, setInboxMinimized] = useState(false);\r\n\r\n  const role = (user?.role ?? \"VIEWER\").toString().toUpperCase();\r\n  const isAdmin = role === \"ADMIN\";\r\n  const isEditor = role === \"EDITOR\" || isAdmin;\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    const controller = new AbortController();\r\n    const signal = controller.signal;\r\n\r\n    async function loadAll() {\r\n      try {\r\n        setLoading(true);\r\n        const [meRes, analyticsRes, threadsRes, numbersRes] = await Promise.all([\r\n          fetch(`/api/me`, { signal }),\r\n          fetch(`/api/analytics/summary`, { signal }),\r\n          fetch(`/api/threads?limit=200`, { signal }),\r\n          fetch(`/api/twilio/numbers`, { signal }),\r\n        ]);\r\n\r\n        if (!mounted) return;\r\n\r\n        if (meRes.ok) {\r\n          const j = await meRes.json().catch(() => null);\r\n          setUser(j?.user ?? null);\r\n        } else {\r\n          setUser(null);\r\n        }\r\n\r\n        if (analyticsRes.ok) {\r\n          const j = await analyticsRes.json().catch(() => null);\r\n          setAnalytics({\r\n            messages7d: j?.messages7d ?? 0,\r\n            avgResponseMins: j?.avgResponseMins ?? 0,\r\n            openRatePct: j?.openRatePct ?? 0,\r\n            sparkline: Array.isArray(j?.sparkline) ? j.sparkline : [1, 2, 3, 2, 4],\r\n          });\r\n        } else {\r\n          setAnalytics(null);\r\n        }\r\n\r\n        if (threadsRes.ok) {\r\n          const j = await threadsRes.json().catch(() => null);\r\n          setThreads(Array.isArray(j?.threads) ? j.threads : []);\r\n        } else {\r\n          setThreads([]);\r\n        }\r\n\r\n        if (numbersRes.ok) {\r\n          const j = await numbersRes.json().catch(() => null);\r\n          setNumbers(Array.isArray(j?.numbers) ? j.numbers : []);\r\n        } else {\r\n          setNumbers([]);\r\n        }\r\n\r\n        // best-effort load contacts\r\n        await fetchContacts(signal);\r\n      } catch (e) {\r\n        if ((e as any)?.name !== \"AbortError\") console.error(\"loadAll error\", e);\r\n      } finally {\r\n        if (mounted) setLoading(false);\r\n      }\r\n    }\r\n\r\n    loadAll();\r\n\r\n    return () => {\r\n      mounted = false;\r\n      controller.abort();\r\n    };\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  /* ----------------------------- fetchContacts ---------------------------- */\r\n  async function fetchContacts(signal?: AbortSignal | null) {\r\n    function normalizeRaw(raw: any): ContactItem | null {\r\n      if (!raw) return null;\r\n      const id = raw.id ?? raw.userId ?? raw.contactId ?? raw._id ?? null;\r\n      const name = raw.name ?? raw.displayName ?? raw.fullName ?? raw.email ?? null;\r\n\r\n      let email: string | null = null;\r\n      let emailVerified = false;\r\n      if (raw.email) {\r\n        email = raw.email;\r\n        emailVerified = Boolean(raw.emailVerified ?? raw.email_verified ?? false);\r\n      } else if (Array.isArray(raw.emails) && raw.emails.length) {\r\n        const p = raw.emails[0];\r\n        email = p?.value ?? p?.address ?? null;\r\n        emailVerified = Boolean(p?.verified ?? false);\r\n      } else if (raw.profile?.email) {\r\n        email = raw.profile.email;\r\n        emailVerified = Boolean(raw.profile.emailVerified ?? false);\r\n      }\r\n\r\n      let phone: string | null = null;\r\n      let phoneVerified = false;\r\n      if (raw.phone) {\r\n        phone = raw.phone;\r\n        phoneVerified = Boolean(raw.phoneVerified ?? false);\r\n      } else if (raw.phoneNumber) {\r\n        phone = raw.phoneNumber;\r\n      } else if (Array.isArray(raw.phones) && raw.phones.length) {\r\n        phone = raw.phones[0]?.value ?? raw.phones[0]?.number ?? null;\r\n        phoneVerified = Boolean(raw.phones[0]?.verified ?? false);\r\n      }\r\n\r\n      if (!id && !email && !phone) return null;\r\n      return {\r\n        id: id ?? email ?? phone ?? String(Math.random()).slice(2, 8),\r\n        name,\r\n        email,\r\n        emailVerified,\r\n        phone,\r\n        phoneVerified,\r\n      };\r\n    }\r\n\r\n    async function tryFetch(url: string) {\r\n      try {\r\n        const opts = signal ? { signal } : undefined;\r\n        const r = await fetch(url, opts as any);\r\n        if (!r.ok) return null;\r\n        const j = await r.json().catch(() => null);\r\n        return j;\r\n      } catch (e) {\r\n        return null;\r\n      }\r\n    }\r\n\r\n    const endpoints = [\"/api/contacts?limit=1000\", \"/api/users?limit=1000\", \"/api/me\", \"/api/admin/users?limit=1000\"];\r\n    const aggregated: ContactItem[] = [];\r\n    for (const ep of endpoints) {\r\n      const d = await tryFetch(ep);\r\n      if (!d) continue;\r\n      if (d.user) {\r\n        const n = normalizeRaw(d.user);\r\n        if (n) aggregated.push(n);\r\n      } else if (Array.isArray(d)) {\r\n        for (const item of d) {\r\n          const n = normalizeRaw(item);\r\n          if (n) aggregated.push(n);\r\n        }\r\n      } else if (Array.isArray(d.contacts)) {\r\n        for (const item of d.contacts) {\r\n          const n = normalizeRaw(item);\r\n          if (n) aggregated.push(n);\r\n        }\r\n      } else if (Array.isArray(d.users)) {\r\n        for (const item of d.users) {\r\n          const n = normalizeRaw(item);\r\n          if (n) aggregated.push(n);\r\n        }\r\n      } else {\r\n        const n = normalizeRaw(d);\r\n        if (n) aggregated.push(n);\r\n      }\r\n      if (aggregated.length > 0) break;\r\n    }\r\n\r\n    // ensure me included\r\n    try {\r\n      const me = await tryFetch(\"/api/me\");\r\n      if (me?.user) {\r\n        const n = normalizeRaw(me.user);\r\n        if (n) aggregated.push(n);\r\n      }\r\n    } catch {}\r\n\r\n    const map = new Map<string, ContactItem>();\r\n    for (const a of aggregated) {\r\n      const key = a.id ?? a.email ?? a.phone ?? JSON.stringify(a);\r\n      if (!map.has(key)) map.set(key, a);\r\n      else {\r\n        const ex = map.get(key)!;\r\n        map.set(key, { ...ex, ...a });\r\n      }\r\n    }\r\n    const result = Array.from(map.values());\r\n    setContacts((prev) => {\r\n      // merge unique\r\n      const merged = new Map<string, ContactItem>();\r\n      prev.forEach((c) => merged.set(c.id, c));\r\n      result.forEach((c) => merged.set(c.id, { ...merged.get(c.id), ...c }));\r\n      return Array.from(merged.values());\r\n    });\r\n  }\r\n\r\n  /* ----------------------------- Realtime WS ---------------------------- */\r\n  useEffect(() => {\r\n    if (!user) return;\r\n    let mounted = true;\r\n    try {\r\n      const ws = new WebSocket((typeof window !== \"undefined\" ? window.location.origin : \"\") + \"/api/ws\");\r\n      wsRef.current = ws;\r\n      ws.onopen = () => {\r\n        ws.send(JSON.stringify({ type: \"hello\", userId: user.id, name: user.name }));\r\n      };\r\n      ws.onmessage = (ev) => {\r\n        try {\r\n          const msg = JSON.parse(ev.data);\r\n          if (msg.type === \"presence\") {\r\n            setPresence((p) => ({ ...p, [msg.userId]: { name: msg.name, idle: msg.idle } }));\r\n          } else if (msg.type === \"presence:leave\") {\r\n            setPresence((p) => {\r\n              const copy = { ...p };\r\n              delete copy[msg.userId];\r\n              return copy;\r\n            });\r\n          } else if (msg.type === \"thread:new\") {\r\n            setThreads((t) => [msg.thread as ThreadPreviewItem, ...t]);\r\n          } else if (msg.type === \"thread:update\") {\r\n            setThreads((t) => t.map((x) => (x.id === msg.thread.id ? msg.thread : x)));\r\n          } else if (msg.type === \"message:new\") {\r\n            // new incoming message — ensure it's in threads and open inbox if desired\r\n            setThreads((t) => {\r\n              const exists = t.find((x) => x.id === msg.thread?.id || x.id === msg.threadId);\r\n              if (exists) {\r\n                return t.map((x) => (x.id === (msg.thread?.id ?? msg.threadId) ? { ...(msg.thread ?? x), unreadCount: (msg.incrementUnread ? ((x.unreadCount ?? 0) + 1) : (msg.thread?.unreadCount ?? x.unreadCount)) } : x));\r\n              } else if (msg.thread) {\r\n                return [msg.thread as ThreadPreviewItem, ...t];\r\n              } else {\r\n                // fallback: create a small thread item\r\n                const small: ThreadPreviewItem = {\r\n                  id: msg.threadId ?? `t-${Math.random().toString(36).slice(2, 8)}`,\r\n                  contactId: msg.from,\r\n                  contactName: msg.fromName ?? msg.from,\r\n                  contactPhone: msg.from,\r\n                  snippet: msg.text ?? \"\",\r\n                  lastAt: new Date().toISOString(),\r\n                  unreadCount: 1,\r\n                  status: \"inbox\",\r\n                };\r\n                return [small, ...t];\r\n              }\r\n            });\r\n          }\r\n        } catch (e) {\r\n          console.warn(\"ws parse error\", e);\r\n        }\r\n      };\r\n      ws.onclose = () => {\r\n        wsRef.current = null;\r\n      };\r\n      return () => {\r\n        try {\r\n          ws.close();\r\n        } catch {}\r\n      };\r\n    } catch (e) {\r\n      if (!mounted) return;\r\n      console.warn(\"Realtime not available\", e);\r\n    }\r\n  }, [user]);\r\n\r\n  /* ----------------------------- Actions ---------------------------- */\r\n\r\n  async function handleBuyNumber(id: string) {\r\n    setBuying(id);\r\n    try {\r\n      const res = await fetch(`/api/twilio/buy`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ id }),\r\n      });\r\n      if (!res.ok) throw new Error(\"failed to buy\");\r\n      // refresh\r\n      const ref = await fetch(`/api/twilio/numbers`);\r\n      if (ref.ok) {\r\n        const j = await ref.json();\r\n        setNumbers(Array.isArray(j?.numbers) ? j.numbers : []);\r\n      }\r\n    } catch (e) {\r\n      console.error(e);\r\n      alert(\"Failed to buy number (check sandbox or logs).\");\r\n    } finally {\r\n      setBuying(null);\r\n    }\r\n  }\r\n\r\n  function openComposer(ctx?: { threadId?: string; contactId?: string }) {\r\n    if (!isEditor) return;\r\n    setComposerContext(ctx ?? null);\r\n    setComposerOpen(true);\r\n  }\r\n  function closeComposer() {\r\n    setComposerOpen(false);\r\n    setComposerContext(null);\r\n  }\r\n\r\n  /* ----------------------------- sendMessage (optimistic) ---------------------------- */\r\n\r\n  async function sendMessage(payload: {\r\n    to: string;\r\n    channel: string;\r\n    body: string;\r\n    scheduleAt?: string;\r\n    threadId?: string;\r\n    contactId?: string;\r\n  }) {\r\n    if (!isEditor) throw new Error(\"not authorized\");\r\n    const isScheduled = !!payload.scheduleAt;\r\n    const optimistic: ThreadPreviewItem = {\r\n      id: isScheduled ? \"sched-\" + Math.random().toString(36).slice(2, 9) : \"tmp-\" + Math.random().toString(36).slice(2, 9),\r\n      contactId: payload.contactId,\r\n      contactName: payload.to,\r\n      contactPhone: payload.to,\r\n      channels: [payload.channel],\r\n      snippet: payload.body,\r\n      lastAt: new Date().toISOString(),\r\n      scheduled: isScheduled,\r\n      status: isScheduled ? \"scheduled\" : \"inbox\",\r\n    };\r\n    setThreads((t) => [optimistic, ...t]);\r\n\r\n    try {\r\n      let res: Response;\r\n      if (isScheduled) {\r\n        res = await fetch(\"/api/messages/schedule\", {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            to: payload.to,\r\n            channel: payload.channel,\r\n            body: payload.body,\r\n            sendAt: payload.scheduleAt,\r\n            threadId: payload.threadId,\r\n            contactId: payload.contactId,\r\n            metadata: { to: payload.to },\r\n          }),\r\n        });\r\n      } else {\r\n        res = await fetch(\"/api/messages/send\", {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            to: payload.to,\r\n            channel: payload.channel,\r\n            body: payload.body,\r\n            threadId: payload.threadId,\r\n            contactId: payload.contactId,\r\n            metadata: { to: payload.to },\r\n          }),\r\n        });\r\n      }\r\n\r\n      const text = await res.text().catch(() => \"\");\r\n      let parsed: any = null;\r\n      try {\r\n        parsed = text ? JSON.parse(text) : null;\r\n      } catch {\r\n        parsed = text;\r\n      }\r\n\r\n      if (!res.ok) {\r\n        setThreads((t) => t.filter((x) => !x.id.startsWith(\"tmp-\") && !x.id.startsWith(\"sched-\")));\r\n        const serverMsg = parsed?.error ?? parsed?.message ?? (typeof parsed === \"string\" ? parsed : `HTTP ${res.status}`);\r\n        alert(`Send failed: ${serverMsg}`);\r\n        throw new Error(`send failed: ${serverMsg}`);\r\n      }\r\n\r\n      const j = parsed ?? {};\r\n      if (j.thread && j.thread.id) {\r\n        setThreads((t) => [j.thread as ThreadPreviewItem, ...t.filter((x) => !x.id.startsWith(\"tmp-\") && !x.id.startsWith(\"sched-\"))]);\r\n      } else {\r\n        setThreads((t) => t.filter((x) => !x.id.startsWith(\"tmp-\")));\r\n      }\r\n\r\n      return j;\r\n    } catch (err) {\r\n      setThreads((t) => t.filter((x) => !x.id.startsWith(\"tmp-\") && !x.id.startsWith(\"sched-\")));\r\n      console.error(err);\r\n      throw err;\r\n    }\r\n  }\r\n\r\n  /* ----------------------------- Kanban columns (unchanged) ---------------------------- */\r\n\r\n  const columns = useMemo(\r\n    () => [\r\n      { key: \"unread\", title: \"Unread\", filter: (t: ThreadPreviewItem) => !!t.unreadCount && (t.unreadCount ?? 0) > 0 },\r\n      { key: \"inbox\", title: \"Inbox\", filter: (t: ThreadPreviewItem) => !t.scheduled && !(t.unreadCount && t.unreadCount > 0) && (!t.status || t.status === \"inbox\") },\r\n      { key: \"scheduled\", title: \"Scheduled\", filter: (t: ThreadPreviewItem) => !!t.scheduled || t.status === \"scheduled\" },\r\n      { key: \"archived\", title: \"Archived\", filter: (t: ThreadPreviewItem) => t.status === \"archived\" },\r\n    ],\r\n    []\r\n  );\r\n\r\n  function getColumnThreads(colKey: string) {\r\n    const col = columns.find((c) => c.key === colKey)!;\r\n    return threads.filter((t) => {\r\n      try {\r\n        return (col.filter as any)(t);\r\n      } catch {\r\n        return false;\r\n      }\r\n    });\r\n  }\r\n\r\n  async function handleDropThread(threadId: string, destColumnKey: string) {\r\n    setThreads((prev) =>\r\n      prev.map((t) => {\r\n        if (t.id === threadId) {\r\n          const newStatus = destColumnKey === \"unread\" ? \"inbox\" : destColumnKey;\r\n          return { ...t, status: newStatus, scheduled: destColumnKey === \"scheduled\" ? true : t.scheduled };\r\n        }\r\n        return t;\r\n      })\r\n    );\r\n    try {\r\n      await fetch(`/api/threads/${threadId}`, {\r\n        method: \"PATCH\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ status: destColumnKey }),\r\n      });\r\n    } catch (e) {\r\n      console.error(\"thread patch failed\", e);\r\n    }\r\n  }\r\n\r\n  /* ----------------------------- UI ---------------------------- */\r\n\r\n  // compute unread count for bubble\r\n  const totalUnread = threads.reduce((s, t) => s + (t.unreadCount ?? 0), 0);\r\n\r\n  return (\r\n    <main className=\"min-h-screen bg-gradient-to-b from-slate-50 via-white to-slate-50 text-slate-900\">\r\n      <div className=\"max-w-7xl mx-auto px-6 py-8\">\r\n        <header className=\"flex items-center justify-between mb-6\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"h-12 w-12 rounded-2xl bg-gradient-to-br from-indigo-600 to-cyan-500 flex items-center justify-center shadow-xl\">\r\n              <svg width=\"28\" height=\"28\" viewBox=\"0 0 24 24\" fill=\"none\" aria-hidden>\r\n                <path d=\"M3 12h18\" stroke=\"white\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                <path d=\"M7 6v12\" stroke=\"white\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n              </svg>\r\n            </div>\r\n            <div>\r\n              <div className=\"text-lg font-bold\">SignalHub</div>\r\n              <div className=\"text-xs text-slate-500\">Unified Inbox • Multi-channel Outreach</div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"hidden sm:flex items-center gap-3 rounded-full px-3 py-1 bg-slate-100 text-sm\">\r\n              <span className=\"text-xs text-slate-500\">Role</span>\r\n              <strong className=\"uppercase\">{role}</strong>\r\n            </div>\r\n\r\n            <div className=\"hidden md:flex items-center gap-3 text-xs text-slate-600\">\r\n              {Object.keys(presence).length === 0 ? (\r\n                <span className=\"text-xs text-slate-400\">No one online</span>\r\n              ) : (\r\n                <div className=\"flex items-center gap-2\">\r\n                  {Object.entries(presence).slice(0, 4).map(([id, p]) => (\r\n                    <div key={id} className=\"flex items-center gap-2\">\r\n                      <span className={`w-2 h-2 rounded-full ${p.idle ? \"bg-yellow-400\" : \"bg-green-400\"}`} />\r\n                      <span className=\"truncate max-w-[8rem]\">{p.name ?? id}</span>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Integrations button - opens functional modal */}\r\n            <button onClick={() => setIntegrationsOpen(true)} className=\"px-3 py-2 rounded-lg border bg-white hover:bg-slate-50\">Integrations</button>\r\n\r\n            {/* Inbox button opens inbox panel */}\r\n            <button onClick={() => { setInboxOpen(true); setInboxMinimized(false); }} className=\"px-3 py-2 rounded-lg bg-gradient-to-r from-indigo-600 to-cyan-500 text-white shadow\">\r\n              Inbox {totalUnread > 0 && <span className=\"ml-2 inline-block bg-amber-400 text-black text-xs px-2 py-0.5 rounded-full\">{totalUnread}</span>}\r\n            </button>\r\n\r\n            <ProfileMenu email={user?.email} avatarUrl={undefined} />\r\n          </div>\r\n        </header>\r\n\r\n        {/* Hero + CTA */}\r\n        <section className=\"grid grid-cols-1 lg:grid-cols-3 gap-6 items-start mb-8\">\r\n          <div className=\"lg:col-span-2 bg-white/60 backdrop-blur rounded-3xl p-6 shadow-lg border border-slate-100\">\r\n            <div className=\"flex items-start gap-6\">\r\n              <div className=\"flex-shrink-0\">\r\n                <div className=\"h-14 w-14 rounded-xl bg-gradient-to-br from-indigo-600 to-cyan-500 flex items-center justify-center shadow-lg\">\r\n                  <svg width=\"28\" height=\"28\" viewBox=\"0 0 24 24\" fill=\"none\" aria-hidden>\r\n                    <path d=\"M3 12h18\" stroke=\"white\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                    <path d=\"M7 6v12\" stroke=\"white\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                  </svg>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex-1\">\r\n                <h1 className=\"text-3xl sm:text-4xl font-extrabold\">Unified Inbox — Kanban for conversations</h1>\r\n                <p className=\"mt-3 text-slate-600 max-w-2xl\">\r\n                  Streamline SMS, WhatsApp and Email into one playbook. Real-time presence, collaborative notes (Yjs), scheduling,\r\n                  and analytics — all under role-based controls.\r\n                </p>\r\n\r\n                <div className=\"mt-5 flex flex-wrap gap-3\">\r\n                  <button onClick={() => (isAdmin ? router.push(\"/admin\") : (setInboxOpen(true), setInboxMinimized(false)))} className=\"inline-flex items-center gap-3 px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-600 to-cyan-500 text-white shadow hover:scale-[1.01]\">\r\n                    {isAdmin ? \"Open Admin\" : \"Open Inbox\"}\r\n                    <svg className=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"none\" aria-hidden>\r\n                      <path d=\"M5 12h14\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                      <path d=\"M12 5l7 7-7 7\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" />\r\n                    </svg>\r\n                  </button>\r\n\r\n                  <button onClick={() => setIntegrationsOpen(true)} className=\"px-4 py-2 rounded-lg border text-slate-700 hover:bg-slate-50\">Integrations</button>\r\n\r\n                  {isEditor && (\r\n                    <button onClick={() => openComposer()} className=\"px-4 py-2 rounded-lg border bg-white text-slate-700 hover:bg-slate-50\">Quick Compose</button>\r\n                  )}\r\n                </div>\r\n\r\n                <div className=\"mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3\">\r\n                  <MiniCard label=\"Unified Threads\" desc=\"Conversations aggregated per contact across channels.\" />\r\n                  <MiniCard label=\"Schedule\" desc=\"Schedule outbound messages and preview per-channel.\" />\r\n                  <MiniCard label=\"Team Collab\" desc=\"Real-time notes with cursors and mentions (Yjs).\" />\r\n                  <MiniCard label=\"Analytics\" desc=\"Response time, channel volume and exportable reports.\" />\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Twilio sandbox & numbers */}\r\n            <div className=\"mt-6 grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div className=\"rounded-xl border border-rose-50 p-4 bg-rose-50/20\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <div>\r\n                    <div className=\"text-sm font-semibold\">Twilio Sandbox</div>\r\n                    <div className=\"text-xs text-slate-600\">Trial — simulated numbers unless purchased</div>\r\n                  </div>\r\n                  <div className=\"text-xs text-slate-500\">Sandbox</div>\r\n                </div>\r\n\r\n                <div className=\"mt-3\">\r\n                  <div className=\"text-xs text-slate-700 mb-2\">Available numbers</div>\r\n                  <div className=\"space-y-2\">\r\n                    {numbers.length === 0 ? (\r\n                      <div className=\"text-xs text-slate-500\">No sandbox numbers found.</div>\r\n                    ) : (\r\n                      numbers.slice(0, 6).map((n) => (\r\n                        <div key={n.id} className=\"flex items-center justify-between bg-white rounded-lg p-2 border\">\r\n                          <div>\r\n                            <div className=\"font-medium\">{n.phone}</div>\r\n                            <div className=\"text-xs text-slate-500\">{n.provider} • {n.capabilities ? Object.keys(n.capabilities).filter((k) => n.capabilities?.[k]).join(\", \") : \"—\"}</div>\r\n                          </div>\r\n                          <div>\r\n                            {n.purchased ? (\r\n                              <span className=\"text-xs text-green-600\">Purchased</span>\r\n                            ) : (\r\n                              <button disabled={!!buying} onClick={() => handleBuyNumber(n.id)} className=\"px-3 py-1 rounded bg-indigo-600 text-white text-xs\">\r\n                                {buying === n.id ? \"Buying…\" : \"Buy\"}\r\n                              </button>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      ))\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              <IntegrationsSummary numbers={numbers} />\r\n            </div>\r\n          </div>\r\n\r\n          {/* right column: analytics + quick actions */}\r\n          <aside className=\"space-y-4\">\r\n            <AnalyticsPanel analytics={analytics} loading={loading} />\r\n            <div className=\"bg-white rounded-2xl p-4 shadow-sm border border-slate-100\">\r\n              <h4 className=\"text-sm font-semibold text-slate-700 mb-2\">Quick actions</h4>\r\n              <div className=\"flex flex-col gap-2\">\r\n                <button disabled={!isEditor} onClick={() => openComposer()} className={`text-left px-3 py-2 rounded-lg ${isEditor ? \"bg-blue-50\" : \"bg-slate-50 text-slate-400\"}`}>Compose</button>\r\n                <button disabled={!isAdmin} onClick={() => router.push(\"/admin\")} className={`text-left px-3 py-2 rounded-lg ${isAdmin ? \"bg-indigo-50\" : \"bg-slate-50 text-slate-400\"}`}>Manage team</button>\r\n                <Link href=\"/analytics\" className=\"text-left px-3 py-2 rounded-lg bg-slate-50\">View analytics</Link>\r\n                <button onClick={() => setIntegrationsOpen(true)} className=\"text-left px-3 py-2 rounded-lg bg-slate-50\">Integrations</button>\r\n              </div>\r\n            </div>\r\n          </aside>\r\n        </section>\r\n\r\n        {/* Kanban + thread preview */}\r\n        <section className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\r\n          <div className=\"lg:col-span-2 bg-white rounded-3xl p-6 shadow border border-slate-100\">\r\n            <div className=\"flex items-center justify-between mb-4\">\r\n              <h2 className=\"text-lg font-semibold\">Unified Inbox</h2>\r\n              <div className=\"flex items-center gap-3\">\r\n                <SearchBar onSearch={(q) => { /* optional hook for remote search */ }} />\r\n                <div className=\"text-sm text-slate-500\">Normalized threads • drag to move</div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"rounded-xl overflow-hidden border border-slate-100 p-4\">\r\n              <div className=\"grid grid-cols-1 sm:grid-cols-4 gap-4\">\r\n                {columns.map((col) => (\r\n                  <div key={col.key} className=\"bg-slate-50 rounded-lg p-3\">\r\n                    <div className=\"flex items-center justify-between mb-3\">\r\n                      <div>\r\n                        <div className=\"text-sm font-semibold\">{col.title}</div>\r\n                        <div className=\"text-xs text-slate-500\">{getColumnThreads(col.key).length} threads</div>\r\n                      </div>\r\n                      <div className=\"text-xs text-slate-400\">•</div>\r\n                    </div>\r\n\r\n                    <div\r\n                      className=\"space-y-2 min-h-[120px] max-h-[48vh] overflow-auto\"\r\n                      onDragOver={(e) => e.preventDefault()}\r\n                      onDrop={(e) => {\r\n                        const threadId = e.dataTransfer.getData(\"text/threadId\");\r\n                        if (threadId) handleDropThread(threadId, col.key);\r\n                      }}\r\n                    >\r\n                      {getColumnThreads(col.key).map((t) => (\r\n                        <ThreadCard\r\n                          key={t.id}\r\n                          thread={t}\r\n                          onOpenContact={(id) => setContactModal({ contactId: id })}\r\n                          onCompose={(thr) => openComposer({ threadId: thr.id, contactId: thr.contactId })}\r\n                        />\r\n                      ))}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-6 text-sm text-slate-600\">\r\n              The Kanban groups threads by status: Unread, Inbox, Scheduled, Archived. Use drag & drop to move threads between columns — server patch is attempted for persistence.\r\n            </div>\r\n          </div>\r\n\r\n          <aside className=\"bg-white rounded-3xl p-6 shadow border border-slate-100\">\r\n            <h3 className=\"text-sm font-semibold mb-3\">Getting started</h3>\r\n            <ol className=\"text-sm space-y-3 list-decimal list-inside text-slate-700\">\r\n              <li>Open <button onClick={() => { setInboxOpen(true); setInboxMinimized(false); }} className=\"text-blue-600 underline\">Inbox</button> for full thread view.</li>\r\n              <li>{isEditor ? \"Compose a test message\" : \"Request editor access.\"}</li>\r\n              <li>Verify Twilio under <button onClick={() => setIntegrationsOpen(true)} className=\"text-blue-600 underline\">Settings</button>.</li>\r\n              <li>{isAdmin ? <Link href=\"/admin\" className=\"text-blue-600\">Manage team</Link> : \"Ask an admin to add you.\"}</li>\r\n            </ol>\r\n\r\n            <div className=\"mt-6\">\r\n              <button onClick={() => { setInboxOpen(true); setInboxMinimized(false); }} className=\"block text-center bg-indigo-600 text-white px-4 py-2 rounded-lg\">Open Inbox</button>\r\n            </div>\r\n          </aside>\r\n        </section>\r\n\r\n        <footer className=\"mt-12 text-center text-sm text-slate-500\">\r\n          Built for the Attack Capital assignment — multi-channel outreach, scheduling, team collaboration and analytics.\r\n        </footer>\r\n\r\n        {/* Integrations modal - functional */}\r\n        {integrationsOpen && (\r\n          <IntegrationsModal\r\n            onClose={() => setIntegrationsOpen(false)}\r\n            numbers={numbers}\r\n            onBuy={(id) => handleBuyNumber(id)}\r\n            buying={buying}\r\n            refresh={() => (async () => { const r = await fetch(\"/api/twilio/numbers\"); if (r.ok) { const j = await r.json(); setNumbers(Array.isArray(j?.numbers) ? j.numbers : []); } })()}\r\n          />\r\n        )}\r\n\r\n        {/* Composer modal */}\r\n        {composerOpen && (\r\n          <ComposerModal\r\n            onClose={closeComposer}\r\n            onSend={async (p) => sendMessage(p)}\r\n            context={composerContext}\r\n            contacts={contacts}\r\n            onSent={() => {\r\n              closeComposer();\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {/* Contact modal */}\r\n        {contactModal && (\r\n          <ContactProfileModal contactId={contactModal.contactId} onClose={() => setContactModal(null)} isEditor={isEditor} />\r\n        )}\r\n\r\n        {/* Inbox Panel (full-screen style) */}\r\n        {inboxOpen && (\r\n          <InboxPanel\r\n            threads={threads}\r\n            onClose={() => setInboxOpen(false)}\r\n            onMinimize={() => { setInboxMinimized(true); setInboxOpen(false); }}\r\n            onOpenThread={(threadId) => {\r\n              // open thread viewer (modal)\r\n              setContactModal({ contactId: threadId }); // reuse contact modal or `ThreadView` could be implemented\r\n            }}\r\n            onRefresh={async () => {\r\n              const r = await fetch(\"/api/threads?limit=200\");\r\n              if (r.ok) {\r\n                const j = await r.json();\r\n                setThreads(Array.isArray(j?.threads) ? j.threads : []);\r\n              }\r\n            }}\r\n          />\r\n        )}\r\n\r\n        {/* Minimized messenger bubble */}\r\n        {inboxMinimized && (\r\n          <MessengerBubble\r\n            unread={totalUnread}\r\n            onOpen={() => { setInboxOpen(true); setInboxMinimized(false); }}\r\n            onClose={() => setInboxMinimized(false)}\r\n          />\r\n        )}\r\n      </div>\r\n    </main>\r\n  );\r\n}\r\n\r\n/* ----------------------------- Integrations modal ---------------------------- */\r\n\r\nfunction IntegrationsModal({ onClose, numbers, onBuy, buying, refresh }: { onClose: () => void; numbers: ProviderNumber[]; onBuy: (id: string) => void; buying: string | null; refresh: () => void }) {\r\n  const [query, setQuery] = useState(\"\");\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center\">\r\n      <div className=\"absolute inset-0 bg-black/40\" onClick={onClose} />\r\n      <div className=\"relative max-w-3xl w-full bg-white rounded-2xl p-6 shadow-lg z-10\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <h3 className=\"text-lg font-semibold\">Integrations — Twilio Numbers</h3>\r\n          <div className=\"flex items-center gap-3\">\r\n            <button onClick={refresh} className=\"px-3 py-1 rounded border text-sm\">Refresh</button>\r\n            <button onClick={onClose} className=\"text-sm text-slate-500\">Close</button>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <input value={query} onChange={(e) => setQuery(e.target.value)} placeholder=\"Filter by country / capability / number\" className=\"rounded border px-3 py-2 flex-1\" />\r\n            <div className=\"text-xs text-slate-500\">Sandbox mode may simulate buys</div>\r\n          </div>\r\n\r\n          <div className=\"mt-4 grid grid-cols-1 gap-3\">\r\n            {numbers.length === 0 ? (\r\n              <div className=\"text-sm text-slate-500\">No available numbers (sandbox or provider). Try refreshing.</div>\r\n            ) : (\r\n              numbers\r\n                .filter((n) => !query || n.phone.includes(query) || (n.provider ?? \"\").toLowerCase().includes(query.toLowerCase()))\r\n                .map((n) => (\r\n                  <div key={n.id} className=\"flex items-center justify-between border rounded p-3 bg-slate-50\">\r\n                    <div>\r\n                      <div className=\"font-medium\">{n.phone}</div>\r\n                      <div className=\"text-xs text-slate-500\">{n.provider ?? \"Twilio\"} • {n.capabilities ? Object.keys(n.capabilities).filter((k) => n.capabilities?.[k]).join(\", \") : \"—\"}</div>\r\n                    </div>\r\n                    <div>\r\n                      {n.purchased ? (\r\n                        <span className=\"text-xs text-green-600\">Purchased</span>\r\n                      ) : (\r\n                        <button disabled={!!buying} onClick={() => onBuy(n.id)} className=\"px-3 py-1 rounded bg-indigo-600 text-white text-xs\">\r\n                          {buying === n.id ? \"Buying…\" : \"Buy now\"}\r\n                        </button>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                ))\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/* ----------------------------- Inbox Panel (full) ---------------------------- */\r\n\r\nfunction InboxPanel({ threads, onClose, onMinimize, onOpenThread, onRefresh }: { threads: ThreadPreviewItem[]; onClose: () => void; onMinimize: () => void; onOpenThread: (threadId: string) => void; onRefresh: () => void }) {\r\n  const [search, setSearch] = useState(\"\");\r\n  const [filterUnread, setFilterUnread] = useState(false);\r\n  const [filterScheduled, setFilterScheduled] = useState(false);\r\n  const [filterDrafts, setFilterDrafts] = useState(false);\r\n\r\n  // filter by contact name / phone / thread snippet\r\n  const filtered = useMemo(() => {\r\n    const q = search.trim().toLowerCase();\r\n    return threads.filter((t) => {\r\n      if (filterUnread && !(t.unreadCount && t.unreadCount > 0)) return false;\r\n      if (filterScheduled && !t.scheduled && t.status !== \"scheduled\") return false;\r\n      if (filterDrafts && !t.isDraft && t.status !== \"draft\") return false;\r\n      if (!q) return true;\r\n      const hay = `${t.contactName ?? \"\"} ${t.contactPhone ?? \"\"} ${t.snippet ?? \"\"}`.toLowerCase();\r\n      return hay.includes(q);\r\n    });\r\n  }, [threads, search, filterUnread, filterScheduled, filterDrafts]);\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-end justify-center md:items-center md:justify-center\">\r\n      <div className=\"absolute inset-0 bg-black/50\" onClick={onClose} />\r\n      <div className=\"relative z-10 bg-white rounded-2xl w-full max-w-5xl h-[80vh] shadow-2xl grid grid-cols-1 md:grid-cols-3 overflow-hidden\">\r\n        <div className=\"col-span-1 md:col-span-1 border-r p-4 flex flex-col gap-3\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h4 className=\"font-semibold\">Inbox</h4>\r\n              <div className=\"text-xs text-slate-500\">All customer conversations</div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <button onClick={onRefresh} className=\"px-2 py-1 rounded bg-slate-100 text-sm\">Refresh</button>\r\n              <button onClick={onMinimize} className=\"px-2 py-1 rounded bg-slate-100 text-sm\">Minimize</button>\r\n              <button onClick={onClose} className=\"px-2 py-1 rounded bg-slate-100 text-sm\">Close</button>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-2\">\r\n            <input placeholder=\"Search by name, phone, message...\" value={search} onChange={(e) => setSearch(e.target.value)} className=\"w-full rounded border px-3 py-2\" />\r\n          </div>\r\n\r\n          <div className=\"mt-2 flex flex-wrap gap-2\">\r\n            <label className={`px-2 py-1 rounded text-sm ${filterUnread ? \"bg-indigo-600 text-white\" : \"bg-slate-100\"}`}>\r\n              <input type=\"checkbox\" checked={filterUnread} onChange={() => setFilterUnread((s) => !s)} className=\"mr-2\" /> Unread\r\n            </label>\r\n            <label className={`px-2 py-1 rounded text-sm ${filterScheduled ? \"bg-amber-500 text-white\" : \"bg-slate-100\"}`}>\r\n              <input type=\"checkbox\" checked={filterScheduled} onChange={() => setFilterScheduled((s) => !s)} className=\"mr-2\" /> Scheduled\r\n            </label>\r\n            <label className={`px-2 py-1 rounded text-sm ${filterDrafts ? \"bg-slate-700 text-white\" : \"bg-slate-100\"}`}>\r\n              <input type=\"checkbox\" checked={filterDrafts} onChange={() => setFilterDrafts((s) => !s)} className=\"mr-2\" /> Drafts\r\n            </label>\r\n          </div>\r\n\r\n          <div className=\"mt-3 overflow-auto flex-1 space-y-2 pr-2\">\r\n            {filtered.length === 0 ? <div className=\"text-sm text-slate-500\">No conversations match your filters.</div> : filtered.map((t) => (\r\n              <div key={t.id} onClick={() => onOpenThread(t.id)} className=\"p-2 rounded-lg bg-white border hover:shadow cursor-pointer flex items-center justify-between\">\r\n                <div>\r\n                  <div className=\"font-medium\">{t.contactName ?? t.contactPhone ?? \"Unknown\"}</div>\r\n                  <div className=\"text-xs text-slate-500\">{t.snippet ?? \"—\"}</div>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                  <div className=\"text-xs text-slate-400\">{formatShortDate(t.lastAt)}</div>\r\n                  {t.unreadCount ? <div className=\"mt-1 inline-block bg-amber-400 text-black px-2 py-0.5 rounded-full text-xs\">{t.unreadCount}</div> : null}\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"col-span-2 md:col-span-2 p-4 overflow-auto\">\r\n          <div className=\"flex items-center justify-between mb-3\">\r\n            <div>\r\n              <div className=\"text-sm text-slate-500\">Conversation Preview</div>\r\n              <div className=\"text-lg font-semibold\">Select a thread to open</div>\r\n            </div>\r\n            <div className=\"text-xs text-slate-400\">Real-time • {filtered.length} threads</div>\r\n          </div>\r\n\r\n          <div className=\"border rounded p-4 h-[62vh] overflow-auto flex flex-col\">\r\n            <div className=\"flex-1 grid place-items-center text-slate-400\">\r\n              <div>Click a thread on the left to view messages. This panel will show messages for the selected contact and allow quick reply, schedule, and attachments.</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/* ----------------------------- Messenger bubble (minimized) ---------------------------- */\r\n\r\nfunction MessengerBubble({ unread, onOpen, onClose }: { unread: number; onOpen: () => void; onClose: () => void }) {\r\n  return (\r\n    <div className=\"fixed bottom-6 right-6 z-50\">\r\n      <div className=\"flex flex-col items-end gap-2\">\r\n        <div className=\"bg-white rounded-xl p-2 shadow-lg w-64\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"w-8 h-8 rounded-full bg-gradient-to-br from-indigo-600 to-cyan-500 flex items-center justify-center text-white\">S</div>\r\n              <div className=\"text-sm font-medium\">SignalHub</div>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <button onClick={onOpen} className=\"px-2 py-1 rounded bg-indigo-600 text-white text-xs\">Open</button>\r\n              <button onClick={onClose} className=\"px-2 py-1 rounded bg-slate-100 text-xs\">Close</button>\r\n            </div>\r\n          </div>\r\n          <div className=\"mt-2 text-xs text-slate-500\">{unread} unread messages</div>\r\n        </div>\r\n\r\n        <button onClick={onOpen} className=\"relative w-14 h-14 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center\">\r\n          <svg className=\"w-6 h-6\" viewBox=\"0 0 24 24\" fill=\"none\" aria-hidden>\r\n            <path d=\"M21 12a9 9 0 10-3.18 6.18L21 21l-1.82-3.18A9 9 0 0021 12z\" stroke=\"white\" strokeWidth=\"1.5\" strokeLinecap=\"round\" strokeLinejoin=\"round\"/>\r\n          </svg>\r\n          {unread > 0 && <span className=\"absolute -top-2 -right-2 bg-amber-400 text-black text-xs px-2 py-0.5 rounded-full\">{unread}</span>}\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/* ----------------------------- Small building blocks ---------------------------- */\r\n\r\nfunction MiniCard({ label, desc }: { label: string; desc: string }) {\r\n  return (\r\n    <div className=\"bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-start gap-3\">\r\n      <div className=\"w-10 h-10 rounded-lg bg-gradient-to-br from-indigo-50 to-cyan-50 flex items-center justify-center\">\r\n        <svg width=\"18\" height=\"18\" viewBox=\"0 0 24 24\" fill=\"none\" aria-hidden>\r\n          <path d=\"M4 7h16M4 12h10M4 17h7\" stroke=\"#0f172a\" strokeWidth=\"1.4\" strokeLinecap=\"round\" />\r\n        </svg>\r\n      </div>\r\n      <div>\r\n        <div className=\"text-sm font-semibold text-slate-800\">{label}</div>\r\n        <div className=\"text-xs text-slate-500 mt-1\">{desc}</div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction IntegrationsSummary({ numbers }: { numbers: ProviderNumber[] }) {\r\n  return (\r\n    <div className=\"rounded-xl border p-4 bg-white\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <div className=\"text-sm font-semibold\">Integration status</div>\r\n          <div className=\"text-xs text-slate-600\">Connected providers & webhook health</div>\r\n        </div>\r\n        <div className=\"text-xs text-slate-500\">OK</div>\r\n      </div>\r\n      <div className=\"mt-3 text-sm text-slate-700\">\r\n        Twilio (Sandbox) — Webhook configured\r\n        <div className=\"mt-2 text-xs text-slate-500\">Available numbers: {numbers.length}</div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction AnalyticsPanel({ analytics, loading }: { analytics: AnalyticsSummary | null; loading: boolean }) {\r\n  return (\r\n    <div className=\"bg-white rounded-2xl p-4 shadow-sm border border-slate-100\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h3 className=\"text-sm font-semibold text-slate-700\">Last 7 days</h3>\r\n        <span className=\"text-xs text-slate-500\">{loading ? \"Loading…\" : \"Updated\"}</span>\r\n      </div>\r\n\r\n      <div className=\"mt-3\">\r\n        <div className=\"flex items-end gap-6\">\r\n          <div>\r\n            <div className=\"text-2xl font-bold\">{analytics?.messages7d ?? \"—\"}</div>\r\n            <div className=\"text-xs text-slate-500\">Messages</div>\r\n          </div>\r\n          <div>\r\n            <div className=\"text-2xl font-bold\">{analytics?.avgResponseMins ?? \"—\"}m</div>\r\n            <div className=\"text-xs text-slate-500\">Avg response</div>\r\n          </div>\r\n          <div>\r\n            <div className=\"text-2xl font-bold\">{analytics?.openRatePct ?? \"—\"}%</div>\r\n            <div className=\"text-xs text-slate-500\">Open rate</div>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"mt-4\">\r\n          <Sparkline data={analytics?.sparkline ?? [1, 2, 3, 2, 4]} />\r\n        </div>\r\n\r\n        <div className=\"mt-4 text-xs text-slate-500\">View full analytics for channel breakdown and exportable reports.</div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/* ----------------------------- ThreadCard (draggable) ---------------------------- */\r\n\r\nfunction ThreadCard({ thread, onOpenContact, onCompose }: { thread: ThreadPreviewItem; onOpenContact: (id: string) => void; onCompose?: (t: ThreadPreviewItem) => void }) {\r\n  return (\r\n    <div\r\n      draggable\r\n      onDragStart={(e) => e.dataTransfer.setData(\"text/threadId\", thread.id)}\r\n      className=\"bg-white rounded-lg p-3 border hover:shadow cursor-grab\"\r\n    >\r\n      <div className=\"flex items-start justify-between gap-3\">\r\n        <div className=\"flex-1\">\r\n          <div className=\"flex items-center justify-between gap-3\">\r\n            <div>\r\n              <div className=\"font-medium\">{thread.contactName ?? thread.contactPhone ?? \"Unknown\"}</div>\r\n              <div className=\"text-xs text-slate-500\">{thread.contactPhone ?? \"—\"} • {(Array.isArray(thread.channels) ? thread.channels.join(\", \") : \"—\")}</div>\r\n            </div>\r\n            <div className=\"text-xs text-slate-400\">{formatShortDate(thread.lastAt)}</div>\r\n          </div>\r\n\r\n          <div className=\"mt-2 text-sm text-slate-700 line-clamp-2\">{thread.snippet ?? \"—\"}</div>\r\n          {thread.scheduled && <div className=\"mt-2 text-xs text-amber-600\">Scheduled</div>}\r\n          {thread.isDraft && <div className=\"mt-2 text-xs text-slate-700\">Draft</div>}\r\n        </div>\r\n\r\n        <div className=\"flex flex-col items-end gap-2\">\r\n          <button onClick={() => onOpenContact(thread.contactId ?? thread.id!)} className=\"text-xs px-2 py-1 rounded bg-slate-50\">Profile</button>\r\n          <button onClick={() => onCompose?.(thread)} className=\"text-xs px-2 py-1 rounded bg-indigo-600 text-white\">Reply</button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/* ----------------------------- Composer Modal ---------------------------- */\r\n\r\nfunction ComposerModal({\r\n  onClose,\r\n  onSend,\r\n  context,\r\n  contacts,\r\n  onSent,\r\n}: {\r\n  onClose: () => void;\r\n  onSend: (payload: { to: string; channel: string; body: string; scheduleAt?: string; contactId?: string }) => Promise<any>;\r\n  context?: { threadId?: string; contactId?: string } | null;\r\n  contacts: ContactItem[];\r\n  onSent?: (p?: any) => void;\r\n}) {\r\n  const [to, setTo] = useState<string>(\"\");\r\n  const [selectedContactId, setSelectedContactId] = useState<string | undefined>(undefined);\r\n  const [channel, setChannel] = useState<\"SMS\" | \"WHATSAPP\" | \"EMAIL\">(\"SMS\");\r\n  const [body, setBody] = useState(\"\");\r\n  const [sendMode, setSendMode] = useState<\"now\" | \"schedule\">(\"now\");\r\n  const [sendAt, setSendAt] = useState<string | null>(null);\r\n  const [sending, setSending] = useState(false);\r\n\r\n  const phoneOptions = useMemo(\r\n    () => contacts.filter((c) => c.phone && c.phoneVerified).map((c) => ({ contactId: c.id, label: `${c.name ?? c.phone} (${c.phone})`, value: c.phone })),\r\n    [contacts]\r\n  );\r\n  const emailOptions = useMemo(\r\n    () => contacts.filter((c) => c.email).map((c) => ({ contactId: c.id, label: `${c.name ?? c.email} (${c.email})`, value: c.email })),\r\n    [contacts]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (!context?.contactId) return;\r\n    const c = contacts.find((x) => x.id === context.contactId);\r\n    if (!c) return;\r\n    if ((channel === \"SMS\" || channel === \"WHATSAPP\") && c.phone && c.phoneVerified) {\r\n      setTo(c.phone);\r\n      setSelectedContactId(c.id);\r\n    } else if (channel === \"EMAIL\" && c.email) {\r\n      setTo(c.email);\r\n      setSelectedContactId(c.id);\r\n    } else {\r\n      if (c.email) {\r\n        setTo(c.email);\r\n        setSelectedContactId(c.id);\r\n      } else if (c.phone && c.phoneVerified) {\r\n        setTo(c.phone);\r\n        setSelectedContactId(c.id);\r\n      }\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [context?.contactId, contacts]);\r\n\r\n  useEffect(() => {\r\n    if (!to) return;\r\n    const isPhone = channel === \"SMS\" || channel === \"WHATSAPP\";\r\n    const match = contacts.find((c) => (isPhone ? c.phone === to && c.phoneVerified : c.email === to));\r\n    if (!match) {\r\n      setSelectedContactId(undefined);\r\n    } else {\r\n      setSelectedContactId(match.id);\r\n    }\r\n  }, [to, channel, contacts]);\r\n\r\n  function buildOptions() {\r\n    if (channel === \"EMAIL\") {\r\n      return emailOptions.map((o) => ({ label: o.label, value: JSON.stringify({ contactId: o.contactId, value: o.value }) }));\r\n    }\r\n    return phoneOptions.map((o) => ({ label: o.label, value: JSON.stringify({ contactId: o.contactId, value: o.value }) }));\r\n  }\r\n\r\n  function onSelectTo(e: React.ChangeEvent<HTMLSelectElement>) {\r\n    const val = e.target.value;\r\n    if (!val) {\r\n      setTo(\"\");\r\n      setSelectedContactId(undefined);\r\n      return;\r\n    }\r\n    try {\r\n      const parsed = JSON.parse(val);\r\n      setTo(parsed.value);\r\n      setSelectedContactId(parsed.contactId);\r\n    } catch {\r\n      setTo(val);\r\n      setSelectedContactId(undefined);\r\n    }\r\n  }\r\n\r\n  async function handleSend() {\r\n    setSending(true);\r\n    try {\r\n      if (!to) {\r\n        alert(\"Select recipient\");\r\n        setSending(false);\r\n        return;\r\n      }\r\n      if (!body.trim()) {\r\n        alert(\"Message body is required\");\r\n        setSending(false);\r\n        return;\r\n      }\r\n\r\n      const payload = {\r\n        to,\r\n        channel,\r\n        body,\r\n        scheduleAt: sendMode === \"schedule\" && sendAt ? sendAt : undefined,\r\n        contactId: selectedContactId,\r\n      };\r\n      await onSend(payload);\r\n      onSent?.(payload);\r\n      onClose();\r\n    } catch (e) {\r\n      console.error(\"send error\", e);\r\n      alert(\"Failed to send\");\r\n    } finally {\r\n      setSending(false);\r\n    }\r\n  }\r\n\r\n  const options = buildOptions();\r\n  const charCount = body.length;\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center\">\r\n      <div className=\"absolute inset-0 bg-black/40\" onClick={onClose} />\r\n      <div className=\"relative max-w-3xl w-full bg-white rounded-2xl p-6 shadow-lg z-10\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <h3 className=\"text-lg font-semibold\">Compose</h3>\r\n          <button onClick={onClose} className=\"text-sm text-slate-500\">Close</button>\r\n        </div>\r\n\r\n        <div className=\"mt-4 grid grid-cols-1 md:grid-cols-3 gap-3\">\r\n          <div className=\"md:col-span-2 space-y-3\">\r\n            <label className=\"text-xs text-slate-600\">To</label>\r\n            <select className=\"w-full rounded border px-3 py-2\" value={to ? JSON.stringify({ contactId: selectedContactId ?? null, value: to }) : \"\"} onChange={onSelectTo}>\r\n              <option value=\"\">— select recipient —</option>\r\n              {options.length === 0 ? <option value=\"\" disabled>No verified recipients</option> : options.map((opt, i) => <option key={i} value={opt.value}>{opt.label}</option>)}\r\n            </select>\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              <div>\r\n                <label className=\"text-xs text-slate-600\">Channel</label>\r\n                <select className=\"w-full rounded border px-3 py-2\" value={channel} onChange={(e) => setChannel(e.target.value as any)}>\r\n                  <option value=\"SMS\">SMS</option>\r\n                  <option value=\"WHATSAPP\">WhatsApp</option>\r\n                  <option value=\"EMAIL\">Email</option>\r\n                </select>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"text-xs text-slate-600\">Send</label>\r\n                <select className=\"w-full rounded border px-3 py-2\" value={sendMode} onChange={(e) => setSendMode(e.target.value as any)}>\r\n                  <option value=\"now\">Now</option>\r\n                  <option value=\"schedule\">Schedule</option>\r\n                </select>\r\n              </div>\r\n            </div>\r\n\r\n            {sendMode === \"schedule\" && (\r\n              <div>\r\n                <label className=\"text-xs text-slate-600\">Send at</label>\r\n                <input type=\"datetime-local\" className=\"w-full rounded border px-3 py-2\" value={sendAt ?? \"\"} onChange={(e) => setSendAt(e.target.value)} />\r\n                <div className=\"text-xs text-slate-400 mt-1\">Scheduled messages execute via the scheduler worker.</div>\r\n              </div>\r\n            )}\r\n\r\n            <div>\r\n              <label className=\"text-xs text-slate-600\">Message</label>\r\n              <textarea rows={6} value={body} onChange={(e) => setBody(e.target.value)} className=\"w-full rounded border px-3 py-2 mt-1\" />\r\n              <div className=\"flex items-center justify-between text-xs text-slate-500 mt-2\">\r\n                <div>{channel === \"SMS\" ? `SMS preview — ${Math.ceil(charCount / 160)} segments` : \"Preview will adapt per channel.\"}</div>\r\n                <div>{charCount} chars</div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <aside className=\"bg-slate-50 rounded p-3 flex flex-col gap-3\">\r\n            <div>\r\n              <div className=\"text-xs text-slate-500\">Preview</div>\r\n              <div className=\"mt-2 p-2 rounded bg-white border text-sm h-36 overflow-auto\">\r\n                <div className=\"font-medium\">{to || \"Recipient\"}</div>\r\n                <div className=\"text-xs text-slate-400 mt-1\">{channel} • {formatShortDate(sendMode === \"schedule\" && sendAt ? sendAt : new Date().toISOString())}</div>\r\n                <div className=\"mt-3 text-slate-700\">{body || <span className=\"text-slate-400\">Message preview will appear here</span>}</div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-auto\">\r\n              <div className=\"flex gap-2\">\r\n                <button onClick={onClose} className=\"px-3 py-2 rounded border w-full\">Cancel</button>\r\n                <button disabled={sending || !to || !body} onClick={handleSend} className=\"px-3 py-2 rounded bg-indigo-600 text-white w-full\">\r\n                  {sending ? \"Sending…\" : sendMode === \"now\" ? \"Send\" : \"Schedule\"}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </aside>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/* ----------------------------- ContactProfileModal + YjsNotes ---------------------------- */\r\n\r\nfunction ContactProfileModal({ contactId, onClose, isEditor }: { contactId: string; onClose: () => void; isEditor: boolean }) {\r\n  const [loading, setLoading] = useState(true);\r\n  const [contact, setContact] = useState<any | null>(null);\r\n  const [notes, setNotes] = useState<any[]>([]);\r\n  const [adding, setAdding] = useState(false);\r\n  const [noteText, setNoteText] = useState(\"\");\r\n\r\n  useEffect(() => {\r\n    let mounted = true;\r\n    const controller = new AbortController();\r\n    const signal = controller.signal;\r\n\r\n    async function load() {\r\n      try {\r\n        const [cRes, nRes] = await Promise.all([fetch(`/api/contacts/${contactId}`, { signal }), fetch(`/api/contacts/${contactId}/notes`, { signal })]);\r\n        if (!mounted) return;\r\n        if (cRes.ok) {\r\n          const cj = await cRes.json().catch(() => null);\r\n          setContact(cj?.contact ?? cj);\r\n        }\r\n        if (nRes.ok) {\r\n          const nj = await nRes.json().catch(() => null);\r\n          setNotes(Array.isArray(nj) ? nj : nj?.notes ?? []);\r\n        }\r\n      } catch (e) {\r\n        if ((e as any)?.name !== \"AbortError\") console.error(e);\r\n      } finally {\r\n        if (mounted) setLoading(false);\r\n      }\r\n    }\r\n\r\n    load();\r\n    return () => {\r\n      mounted = false;\r\n      controller.abort();\r\n    };\r\n  }, [contactId]);\r\n\r\n  async function handleAddNote() {\r\n    if (!noteText.trim()) return;\r\n    setAdding(true);\r\n    try {\r\n      const res = await fetch(`/api/contacts/${contactId}/notes`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ body: noteText }),\r\n      });\r\n      if (!res.ok) throw new Error(\"failed to add note\");\r\n      const j = await res.json().catch(() => null);\r\n      setNotes((s) => [j ?? { id: String(Math.random()), body: noteText }, ...s]);\r\n      setNoteText(\"\");\r\n    } catch (e) {\r\n      console.error(e);\r\n      alert(\"Failed to add note\");\r\n    } finally {\r\n      setAdding(false);\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center\">\r\n      <div className=\"absolute inset-0 bg-black/40\" onClick={onClose} />\r\n      <div className=\"relative max-w-4xl w-full bg-white rounded-2xl p-6 shadow-lg z-10\">\r\n        <div className=\"flex items-start justify-between\">\r\n          <h3 className=\"text-lg font-semibold\">Contact</h3>\r\n          <button onClick={onClose} className=\"text-sm text-slate-500\">Close</button>\r\n        </div>\r\n\r\n        {loading ? (\r\n          <div className=\"mt-4\">Loading…</div>\r\n        ) : (\r\n          <div className=\"mt-4 grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n            <div className=\"md:col-span-2\">\r\n              <div className=\"text-sm font-semibold\">{contact?.name ?? contact?.phone ?? \"Contact\"}</div>\r\n              <div className=\"text-xs text-slate-500 mt-1\">{contact?.email ?? \"—\"}</div>\r\n\r\n              <div className=\"mt-4\">\r\n                <div className=\"text-sm font-medium\">Shared notes</div>\r\n                <div className=\"mt-2\">\r\n                  <YjsNotes contactId={contactId} currentUser={{ id: \"me\", name: contact?.name ?? \"You\" }} />\r\n                </div>\r\n\r\n                <div className=\"mt-4\">\r\n                  <div className=\"text-sm font-medium\">Saved notes</div>\r\n                  <div className=\"mt-2 space-y-2\">\r\n                    {notes.length === 0 ? <div className=\"text-xs text-slate-500\">No notes</div> : notes.map((n) => <div key={n.id ?? JSON.stringify(n)} className=\"p-2 bg-slate-50 rounded\">{n.encrypted ? \"(encrypted)\" : n.body}</div>)}\r\n                  </div>\r\n\r\n                  {isEditor && (\r\n                    <div className=\"mt-4\">\r\n                      <textarea value={noteText} onChange={(e) => setNoteText(e.target.value)} rows={3} className=\"w-full rounded border px-3 py-2 mt-1\" placeholder=\"Add private note\" />\r\n                      <div className=\"mt-2 flex justify-end\">\r\n                        <button disabled={adding || !noteText.trim()} onClick={handleAddNote} className=\"px-3 py-1 rounded bg-indigo-600 text-white text-sm\">{adding ? \"Adding…\" : \"Add note\"}</button>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"md:col-span-1\">\r\n              <div className=\"text-sm font-medium\">Quick actions</div>\r\n              <div className=\"mt-2 flex flex-col gap-2\">\r\n                <Link href={`/inbox?contact=${contactId}`} className=\"px-3 py-2 rounded bg-indigo-600 text-white text-sm text-center\">Open thread</Link>\r\n                <button className=\"px-3 py-2 rounded bg-slate-50 text-sm\">Merge</button>\r\n                <button className=\"px-3 py-2 rounded bg-slate-50 text-sm\">Export</button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/* ----------------------------- YjsNotes ---------------------------- */\r\n\r\nfunction YjsNotes({ contactId, currentUser }: { contactId: string; currentUser: { id?: string; name?: string } }) {\r\n  const [text, setText] = useState(\"\");\r\n  const ydocRef = useRef<Y.Doc | null>(null);\r\n  const providerRef = useRef<WebsocketProvider | null>(null);\r\n\r\n  useEffect(() => {\r\n    const wsUrl = process.env.NEXT_PUBLIC_YJS_WS || \"ws://localhost:1234\";\r\n    const doc = new Y.Doc();\r\n    ydocRef.current = doc;\r\n    const provider = new WebsocketProvider(wsUrl, `contact-notes-${contactId}`, doc);\r\n    providerRef.current = provider;\r\n\r\n    const ytext = doc.getText(\"notes\");\r\n    setText(ytext.toString());\r\n    const obs = () => setText(ytext.toString());\r\n    ytext.observe(obs);\r\n\r\n    try {\r\n      provider.awareness.setLocalStateField(\"user\", { id: currentUser?.id, name: currentUser?.name ?? \"Unknown\" });\r\n    } catch {}\r\n\r\n    return () => {\r\n      try {\r\n        ytext.unobserve(obs);\r\n      } catch {}\r\n      try {\r\n        provider.disconnect();\r\n      } catch {}\r\n      doc.destroy();\r\n    };\r\n  }, [contactId, currentUser?.id, currentUser?.name]);\r\n\r\n  function onChangeLocal(e: React.ChangeEvent<HTMLTextAreaElement>) {\r\n    const doc = ydocRef.current;\r\n    if (!doc) return;\r\n    const ytext = doc.getText(\"notes\");\r\n    ytext.delete(0, ytext.length);\r\n    ytext.insert(0, e.target.value);\r\n    setText(e.target.value);\r\n  }\r\n\r\n  async function saveSnapshotToDB() {\r\n    const doc = ydocRef.current;\r\n    if (!doc) return;\r\n    const val = doc.getText(\"notes\").toString();\r\n    try {\r\n      await fetch(`/api/contacts/${contactId}/notes`, {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ body: val }),\r\n      });\r\n      alert(\"Saved snapshot\");\r\n    } catch (e) {\r\n      console.error(e);\r\n      alert(\"Save failed\");\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      <textarea className=\"w-full rounded border px-3 py-2 mt-1\" rows={6} value={text} onChange={onChangeLocal} />\r\n      <div className=\"flex justify-end mt-2 gap-2\">\r\n        <button onClick={saveSnapshotToDB} className=\"px-3 py-1 rounded bg-slate-50\">Save snapshot</button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/* ----------------------------- Sparkline ---------------------------- */\r\n\r\nfunction Sparkline({ data }: { data: number[] }) {\r\n  const width = 160;\r\n  const height = 40;\r\n  const max = Math.max(...data);\r\n  const min = Math.min(...data);\r\n  const points = data\r\n    .map((v, i) => {\r\n      const x = (i / (data.length - 1 || 1)) * width;\r\n      const y = height - ((v - min) / (max - min || 1)) * height;\r\n      return `${x},${y}`;\r\n    })\r\n    .join(\" \");\r\n\r\n  return (\r\n    <svg width={width} height={height} viewBox={`0 0 ${width} ${height}`} aria-hidden>\r\n      <polyline fill=\"none\" stroke=\"#4F46E5\" strokeWidth={2} strokeLinejoin=\"round\" strokeLinecap=\"round\" points={points} />\r\n    </svg>\r\n  );\r\n}\r\n\r\n/* ----------------------------- SearchBar ---------------------------- */\r\n\r\nfunction SearchBar({ onSearch }: { onSearch: (q: string) => void }) {\r\n  const [q, setQ] = useState(\"\");\r\n  return (\r\n    <div className=\"flex items-center bg-slate-100 rounded px-3 py-1\">\r\n      <input value={q} onChange={(e) => setQ(e.target.value)} onKeyDown={(e) => e.key === \"Enter\" && onSearch(q)} placeholder=\"Search threads, contacts...\" className=\"bg-transparent outline-none text-sm\" />\r\n      <button onClick={() => onSearch(q)} className=\"text-xs px-2 py-1 rounded bg-slate-200\">Search</button>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}